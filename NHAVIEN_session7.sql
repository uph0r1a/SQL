CREATE DATABASE NHANVIEN_SESSION7
USE NHANVIEN_SESSION7

CREATE TABLE LOAI
(
    MALOAI CHAR(5) NOT NULL,
    TENLOAI NVARCHAR(50) NOT NULL
)

CREATE TABLE SANPHAM
(
    MASP CHAR(5) NOT NULL,
    TENSP NVARCHAR(50) NOT NULL,
    MALOAI CHAR(5) NOT NULL
)

CREATE TABLE NHANVIEN
(
    MANV CHAR(5) NOT NULL,
    HOTEN NVARCHAR(50) NOT NULL,
    NGAYSINH DATE NOT NULL,
    PHAI VARCHAR(3) NOT NULL
)

CREATE TABLE PHIEUXUAT
(
    MAPX CHAR(5) NOT NULL,
    NGAYLAP DATE NOT NULL,
    MANV CHAR(5) NOT NULL,
)

CREATE TABLE CHITIETXUAT
(
    MAPX CHAR(5) NOT NULL,
    MASP CHAR(5) NOT NULL,
    SOLUONG INT NOT NULL
)

ALTER TABLE LOAI 
ADD CONSTRAINT PK_LOAI PRIMARY KEY(MALOAI);

ALTER TABLE SANPHAM 
ADD CONSTRAINT PK_SANPHAM PRIMARY KEY(MASP);

ALTER TABLE NHANVIEN 
ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY(MANV);

ALTER TABLE PHIEUXUAT 
ADD CONSTRAINT PK_PHIEUXUAT PRIMARY KEY(MAPX);

ALTER TABLE CHITIETXUAT 
ADD CONSTRAINT PK_CHITIETXUAT PRIMARY KEY(MAPX, MASP);

ALTER TABLE SANPHAM
ADD CONSTRAINT FK_SANPHAM_LOAI
FOREIGN KEY (MALOAI)
REFERENCES LOAI(MALOAI);

ALTER TABLE PHIEUXUAT
ADD CONSTRAINT FK_PHIEUXUAT_NHANVIEN
FOREIGN KEY (MANV)
REFERENCES NHANVIEN(MANV);

ALTER TABLE CHITIETXUAT
ADD CONSTRAINT FK_CHITIETXUAT_PHIEUXUAT
FOREIGN KEY (MAPX)
REFERENCES PHIEUXUAT(MAPX);

ALTER TABLE CHITIETXUAT
ADD CONSTRAINT FK_CHITIETXUAT_SANPHAM
FOREIGN KEY (MASP)
REFERENCES SANPHAM(MASP);

INSERT INTO LOAI
VALUES
    ('L001', N'Điện tử'),
    ('L002', N'Gia dụng'),
    ('L003', N'Văn phòng');

INSERT INTO SANPHAM
VALUES
    ('SP01', N'Tivi Samsung', 'L001'),
    ('SP02', N'Máy giặt LG', 'L002'),
    ('SP03', N'Máy in HP', 'L003');

INSERT INTO NHANVIEN
VALUES
    ('NV01', N'Nguyễn Văn A', '1995-05-10', 'Nam'),
    ('NV02', N'Trần Thị B', '1998-08-20', 'Nu');

INSERT INTO PHIEUXUAT
VALUES
    ('PX01', '2024-01-10', 'NV01'),
    ('PX02', '2024-01-12', 'NV02');

INSERT INTO CHITIETXUAT
VALUES
    ('PX01', 'SP01', 5),
    ('PX01', 'SP03', 2),
    ('PX02', 'SP02', 3);

SELECT sp.MASP, sp.TENSP, SUM(ctx.SOLUONG) AS TongSoLuongXuat
FROM SANPHAM sp
    JOIN CHITIETXUAT ctx ON sp.MASP = ctx.MASP
    JOIN PHIEUXUAT px ON ctx.MAPX = px.MAPX
WHERE YEAR(px.NGAYLAP) = 2006
GROUP BY sp.MASP, sp.TENSP
ORDER BY sp.TENSP ASC;

SELECT DISTINCT sp.MASP, sp.TENSP, l.TENLOAI
FROM SANPHAM sp
    JOIN LOAI l ON sp.MALOAI = l.MALOAI
    JOIN CHITIETXUAT ctx ON sp.MASP = ctx.MASP
    JOIN PHIEUXUAT px ON ctx.MAPX = px.MAPX
WHERE px.NGAYLAP BETWEEN '2006-01-01' AND '2006-06-30';

SELECT l.MALOAI, l.TENLOAI, COUNT(sp.MASP) AS SoLuongSanPham
FROM LOAI l
    LEFT JOIN SANPHAM sp ON l.MALOAI = sp.MALOAI
GROUP BY l.MALOAI, l.TENLOAI;

SELECT COUNT(*) AS TongSoPhieuXuat
FROM PHIEUXUAT
WHERE MONTH(NGAYLAP) = 6
    AND YEAR(NGAYLAP) = 2006;

SELECT *
FROM PHIEUXUAT
WHERE MANV = 'NV01';

SELECT MANV, HOTEN, NGAYSINH, DATEDIFF(YEAR, NGAYSINH, GETDATE()) AS Tuoi
FROM NHANVIEN
WHERE PHAI = N'Nam' AND DATEDIFF(YEAR, NGAYSINH, GETDATE()) BETWEEN 26 AND 29;

SELECT nv.MANV, nv.HOTEN, COUNT(px.MAPX) AS SoLuongPhieuXuat
FROM NHANVIEN nv
    LEFT JOIN PHIEUXUAT px ON nv.MANV = px.MANV
GROUP BY nv.MANV, nv.HOTEN;

SELECT TOP 1
    nv.HOTEN, COUNT(px.MAPX) AS SoLuongPhieuXuat
FROM NHANVIEN nv
    JOIN PHIEUXUAT px ON nv.MANV = px.MANV
GROUP BY nv.HOTEN
ORDER BY COUNT(px.MAPX) DESC;

SELECT TOP 1
    sp.TENSP, SUM(ctx.SOLUONG) AS TongSoLuong
FROM SANPHAM sp
    JOIN CHITIETXUAT ctx ON sp.MASP = ctx.MASP
    JOIN PHIEUXUAT px ON ctx.MAPX = px.MAPX
WHERE YEAR(px.NGAYLAP) = 2005
GROUP BY sp.TENSP
ORDER BY SUM(ctx.SOLUONG) DESC;
