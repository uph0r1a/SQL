CREATE DATABASE NHANVIEN_SESSION7
USE NHANVIEN_SESSION7

CREATE TABLE LOAI
(
    MALOAI CHAR(5) NOT NULL,
    TENLOAI NVARCHAR(50) NOT NULL
)

CREATE TABLE SANPHAM
(
    MASP CHAR(5) NOT NULL,
    TENSP NVARCHAR(50) NOT NULL,
    MALOAI CHAR(5) NOT NULL
)

CREATE TABLE NHANVIEN
(
    MANV CHAR(5) NOT NULL,
    HOTEN NVARCHAR(50) NOT NULL,
    NGAYSINH DATE NOT NULL,
    PHAI VARCHAR(3) NOT NULL
)

CREATE TABLE PHIEUXUAT
(
    MAPX CHAR(5) NOT NULL,
    NGAYLAP DATE NOT NULL,
    MANV CHAR(5) NOT NULL,
)

CREATE TABLE CHITIETXUAT
(
    MAPX CHAR(5) NOT NULL,
    MASP CHAR(5) NOT NULL,
    SOLUONG INT NOT NULL
)

ALTER TABLE LOAI 
ADD CONSTRAINT PK_LOAI PRIMARY KEY(MALOAI);

ALTER TABLE SANPHAM 
ADD CONSTRAINT PK_SANPHAM PRIMARY KEY(MASP);

ALTER TABLE NHANVIEN 
ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY(MANV);

ALTER TABLE PHIEUXUAT 
ADD CONSTRAINT PK_PHIEUXUAT PRIMARY KEY(MAPX);

ALTER TABLE CHITIETXUAT 
ADD CONSTRAINT PK_CHITIETXUAT PRIMARY KEY(MAPX, MASP);

ALTER TABLE SANPHAM
ADD CONSTRAINT FK_SANPHAM_LOAI
FOREIGN KEY (MALOAI)
REFERENCES LOAI(MALOAI);

ALTER TABLE PHIEUXUAT
ADD CONSTRAINT FK_PHIEUXUAT_NHANVIEN
FOREIGN KEY (MANV)
REFERENCES NHANVIEN(MANV);

ALTER TABLE CHITIETXUAT
ADD CONSTRAINT FK_CHITIETXUAT_PHIEUXUAT
FOREIGN KEY (MAPX)
REFERENCES PHIEUXUAT(MAPX);

ALTER TABLE CHITIETXUAT
ADD CONSTRAINT FK_CHITIETXUAT_SANPHAM
FOREIGN KEY (MASP)
REFERENCES SANPHAM(MASP);

INSERT INTO LOAI
VALUES
    ('L001', N'Điện tử'),
    ('L002', N'Gia dụng'),
    ('L003', N'Văn phòng');

INSERT INTO SANPHAM
VALUES
    ('SP01', N'Tivi Samsung', 'L001'),
    ('SP02', N'Máy giặt LG', 'L002'),
    ('SP03', N'Máy in HP', 'L003');

INSERT INTO NHANVIEN
VALUES
    ('NV01', N'Nguyễn Văn A', '1995-05-10', 'Nam'),
    ('NV02', N'Trần Thị B', '1998-08-20', 'Nu');

INSERT INTO PHIEUXUAT
VALUES
    ('PX01', '2024-01-10', 'NV01'),
    ('PX02', '2024-01-12', 'NV02');

INSERT INTO CHITIETXUAT
VALUES
    ('PX01', 'SP01', 5),
    ('PX01', 'SP03', 2),
    ('PX02', 'SP02', 3);

SELECT SANPHAM.MASP, SANPHAM.TENSP, SUM(CHITIETXUAT.SOLUONG) AS TONG_SO_LUONG_XUAT
FROM SANPHAM
    JOIN CHITIETXUAT ON SANPHAM.MASP = CHITIETXUAT.MASP
    JOIN PHIEUXUAT ON CHITIETXUAT.MAPX = PHIEUXUAT.MAPX
WHERE YEAR(PHIEUXUAT.NGAYLAP) = 2006
GROUP BY SANPHAM.MASP, SANPHAM.TENSP
ORDER BY SANPHAM.TENSP ASC;
