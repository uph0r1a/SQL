CREATE DATABASE QLDUAN
USE QLDUAN

CREATE TABLE NHANVIEN
(
    MANV CHAR(2) NOT NULL,
    HOTEN NVARCHAR(50) NOT NULL,
    NGAYSINH DATE NOT NULL,
    GT NCHAR(3) NOT NULL,
    MA_P CHAR(2) NOT NULL,
    LUONG INT NOT NULL
)

CREATE TABLE PHONG
(
    MA_P CHAR(2) NOT NULL,
    TENPHONG NVARCHAR(50) NOT NULL
)

CREATE TABLE DIA_DIEM_DV
(
    MA_DV CHAR(2) NOT NULL,
    DIA_DIEM NVARCHAR(50) NOT NULL
)

CREATE TABLE DU_AN
(
    MA_DA CHAR(2) NOT NULL,
    TEN_DA NVARCHAR(50) NOT NULL,
    DIADIEM_DA NVARCHAR(50) NOT NULL,
    MA_DV CHAR(2) NOT NULL,
)

CREATE TABLE CHAM_CONG
(
    MANV CHAR(2) NOT NULL,
    MA_DA CHAR(2) NOT NULL,
    SO_GIO INT NOT NULL
)

ALTER TABLE PHONG
ADD CONSTRAINT PK_PHONG PRIMARY KEY (MA_P)

ALTER TABLE NHANVIEN
ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)

ALTER TABLE DIA_DIEM_DV
ADD CONSTRAINT PK_DIA_DIEM_DV PRIMARY KEY (MA_DV)

ALTER TABLE DU_AN
ADD CONSTRAINT PK_DU_AN PRIMARY KEY (MA_DA)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT PK_CHAM_CONG PRIMARY KEY (MANV, MA_DA)

ALTER TABLE NHANVIEN
ADD CONSTRAINT FK_NHANVIEN_PHONG
FOREIGN KEY (MA_P)
REFERENCES PHONG(MA_P)

ALTER TABLE DU_AN
ADD CONSTRAINT FK_DUAN_DIA_DIEM
FOREIGN KEY (MA_DV)
REFERENCES DIA_DIEM_DV(MA_DV)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT FK_CHAMCONG_NHANVIEN
FOREIGN KEY (MANV)
REFERENCES NHANVIEN(MANV)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT FK_CHAMCONG_DUAN
FOREIGN KEY (MA_DA)
REFERENCES DU_AN(MA_DA)

INSERT INTO PHONG
VALUES
    ('P1', N'Hành chính quản trị'),
    ('P2', N'Kỹ thuật'),
    ('P3', N'Giám đốc')

INSERT INTO DIA_DIEM_DV
VALUES
    ('P1', N'2 Lê Lợi'),
    ('P2', N'3 Hoàng Quốc Việt'),
    ('P3', N'4 Nguyễn Trãi')

INSERT INTO NHANVIEN
VALUES
    ('01', N'Nguyễn Văn Hà', '30/4/1980', N'Nữ', 'P1', 5000000),
    ('02', N'Hoàng Lê Chi', '28/03/1990', N'Nữ', 'P2', 1500000),
    ('03', N'Nguyễn Quang Tèo', '17/8/1988', N'Nam', 'P2', 2000000),
    ('04', N'Lê Thu Hà', '18/9/1987', N'Nữ', 'P3', 3000000),
    ('05', N'Trần Thị Hiền', '15/5/1986', N'Nữ', 'P1', 4000000),
    ('06', N'Đặng Thị Thanh Phương', '2/4/1989 ', N'Nữ', 'P3', 2500000)

INSERT INTO DU_AN
VALUES
    ('D1', N'Phần mềm A', N'Bộ Thủy Lợi', 'P3'),
    ('D2', N'Mạng B', N'UBND Từ Liêm', 'P1'),
    ('D6', N'Agent C', N'TT khí tượng thủy văn HN', 'P2')

INSERT INTO CHAM_CONG
VALUES
    ('01', 'D1', 10),
    ('02', 'D6', 2),
    ('03', 'D1', 8),
    ('01', 'D2', 4),
    ('05', 'D2', 5 ),
    ('06', 'D6', 7 ),
    ('06', 'D2', 3),
    ('01', 'D6', 8),
    ('03', 'D6', 12),
    ('04', 'D1', 5),
    ('06', 'D1', 8)

SELECT MAX(LUONG) AS LUONG_CAO_NHAT, MIN(LUONG) AS LUONG_THAP_NHAT, AVG(LUONG) AS LUONG_TRUNG_BINH
FROM NHANVIEN;

SELECT COUNT(*) AS SO_NHAN_VIEN, SUM(LUONG) AS TONG_LUONG
FROM NHANVIEN
WHERE MA_P = 'P1';

SELECT MA_P, COUNT(*) AS SO_NHAN_VIEN, MAX(LUONG) AS LUONG_CAO_NHAT, MIN(LUONG) AS LUONG_THAP_NHAT, SUM(LUONG) AS TONG_LUONG
FROM NHANVIEN
GROUP BY MA_P
HAVING SUM(LUONG) > 3000000;

SELECT MANV, HOTEN
FROM NHANVIEN
WHERE MA_P = (
    SELECT MA_P
FROM PHONG
WHERE TENPHONG = N'Kỹ thuật'
);

SELECT *
FROM NHANVIEN
WHERE MA_P IN (
    SELECT MA_DV
FROM DIA_DIEM_DV
WHERE DIA_DIEM = N'2 Lê Lợi'
);

SELECT HOTEN, LUONG
FROM NHANVIEN
WHERE LUONG > ALL (
    SELECT LUONG
FROM NHANVIEN
WHERE MA_P = 'P2'
);

SELECT HOTEN, LUONG
FROM NHANVIEN
WHERE LUONG > (
    SELECT AVG(LUONG)
FROM NHANVIEN
);

SELECT *
FROM NHANVIEN
WHERE LUONG > ANY (
    SELECT LUONG
FROM NHANVIEN
WHERE MA_P = (
        SELECT MA_P
FROM PHONG
WHERE TENPHONG = N'Kỹ thuật'
    )
);
