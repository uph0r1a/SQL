CREATE DATABASE QLY_DUAN;
USE QLY_DUAN;

CREATE TABLE PHONG_BAN
(
    MA_PB CHAR(5) NOT NULL,
    TEN_PB NVARCHAR(50) NOT NULL,
    MA_TRUONGPHONG CHAR(5) NOT NULL
);

CREATE TABLE NHAN_VIEN
(
    ID_NHANVIEN CHAR(5) NOT NULL,
    HO_NV NVARCHAR(30) NOT NULL,
    TEN_NV NVARCHAR(30) NOT NULL,
    NAM_SINH INT NOT NULL,
    DIA_CHI NVARCHAR(100) NOT NULL,
    GIOI_TINH CHAR(1) NOT NULL,
    LUONG DECIMAL(12,2),
    PHG CHAR(5) NOT NULL
);

CREATE TABLE DU_AN
(
    MA_DUAN CHAR(5) NOT NULL,
    TEN_DUAN NVARCHAR(50) NOT NULL,
    NGAY_BAT_DAU DATE NOT NULL,
    NGAY_KET_THUC DATE NOT NULL
);

CREATE TABLE QUANLY_DUAN
(
    MA_DUAN CHAR(5) NOT NULL,
    MA_NHANVIEN CHAR(5) NOT NULL,
    NGAY_THAM_GIA DATE NOT NULL,
    NGAY_KET_THUC DATE NOT NULL,
    SO_GIO INT NOT NULL,
    VAI_TRO NVARCHAR(50) NOT NULL
);

ALTER TABLE PHONG_BAN
ADD CONSTRAINT PK_PHONG_BAN PRIMARY KEY (MA_PB)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY (ID_NHANVIEN)

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT PK_QUANLY_DUAN PRIMARY KEY (MA_DUAN,MA_NHANVIEN)

ALTER TABLE DU_AN
ADD CONSTRAINT PK_DUAN PRIMARY KEY (MA_DUAN)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT FK_NHAN_VIEN_PHONGBAN
FOREIGN KEY(PHG)
REFERENCES PHONG_BAN(MA_PB)

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT FK_QUANLY_DUAN_NHAN_VIEN
FOREIGN KEY(MA_NHANVIEN)
REFERENCES NHAN_VIEN(ID_NHANVIEN)

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT FK_QUANLY_DUAN_DU_AN
FOREIGN KEY(MA_DUAN)
REFERENCES DU_AN(MA_DUAN)

INSERT INTO PHONG_BAN
    (MA_PB, TEN_PB, MA_TRUONGPHONG)
VALUES
    ('PB001', N'Công nghệ thông tin', 'NV001'),
    ('PB002', N'Kế toán', 'NV002'),
    ('PB003', N'Nhân sự', 'NV003');

INSERT INTO NHAN_VIEN
    (ID_NHANVIEN, HO_NV, TEN_NV, NAM_SINH, DIA_CHI, GIOI_TINH, LUONG, PHG)
VALUES
    ('NV001', N'Nguyễn', N'An', 1995, N'Hà Nội', 'M', 15000000, 'PB001'),
    ('NV002', N'Trần', N'Bình', 1990, N'Hồ Chí Minh', 'M', 18000000, 'PB002'),
    ('NV003', N'Lê', N'Hoa', 1998, N'Đà Nẵng', 'F', 14000000, 'PB003'),
    ('NV004', N'Phạm', N'Minh', 1997, N'Hà Nội', 'M', 16000000, 'PB001'),
    ('NV005', N'Võ', N'Thảo', 1996, N'Hải Phòng', 'F', 15500000, 'PB002');

INSERT INTO DU_AN
    (MA_DUAN, TEN_DUAN, NGAY_BAT_DAU, NGAY_KET_THUC)
VALUES
    ('DA001', N'Hệ thống quản lý nhân sự', '2024-01-01', '2024-06-30'),
    ('DA002', N'Website bán hàng', '2024-02-15', '2024-08-31'),
    ('DA003', N'Ứng dụng di động', '2024-03-01', '2024-12-31');

INSERT INTO QUANLY_DUAN
    (MA_DUAN, MA_NHANVIEN, NGAY_THAM_GIA, NGAY_KET_THUC, SO_GIO, VAI_TRO)
VALUES
    ('DA001', 'NV001', '2024-01-01', '2024-06-30', 300, N'Lập trình viên'),
    ('DA001', 'NV003', '2024-02-01', '2024-06-30', 200, N'Kiểm thử'),
    ('DA002', 'NV002', '2024-02-15', '2024-08-31', 350, N'Quản lý dự án'),
    ('DA002', 'NV005', '2024-03-01', '2024-08-31', 180, N'Kế toán dự án'),
    ('DA003', 'NV004', '2024-03-01', '2024-12-31', 400, N'Lập trình viên');
GO

CREATE VIEW V_NhanVien_PhongBan
AS
    SELECT NV.ID_NHANVIEN, NV.TEN_NV, PB.MA_PB, PB.TEN_PB
    FROM NHAN_VIEN NV
        INNER JOIN PHONG_BAN PB ON NV.PHG = PB.MA_PB;
GO

SELECT *
FROM V_NhanVien_PhongBan;
GO

CREATE VIEW V_NhanVien_LuongCao
AS
    SELECT ID_NHANVIEN, TEN_NV, LUONG,
        CASE 
           WHEN LUONG > 15000000 THEN N'Cao'
           ELSE N'Trung'
       END AS CapBac
    FROM NHAN_VIEN
    WHERE LUONG > 10000000;
GO

CREATE VIEW V_DuAn_ChiTiet
AS
    SELECT DA.MA_DUAN, DA.TEN_DUAN, NV.TEN_NV, PB.TEN_PB
    FROM DU_AN DA
        JOIN QUANLY_DUAN QL ON DA.MA_DUAN = QL.MA_DUAN
        JOIN NHAN_VIEN NV ON QL.MA_NHANVIEN = NV.ID_NHANVIEN
        JOIN PHONG_BAN PB ON NV.PHG = PB.MA_PB;
GO

CREATE VIEW V_PhongBan_LuongTB
AS
    SELECT PB.MA_PB, PB.TEN_PB, AVG(NV.LUONG) AS LuongTB
    FROM PHONG_BAN PB
        JOIN NHAN_VIEN NV ON PB.MA_PB = NV.PHG
    GROUP BY PB.MA_PB, PB.TEN_PB;
GO

CREATE VIEW V_DuAn_HoanThanh
AS
    SELECT DA.MA_DUAN, DA.TEN_DUAN,
        (SELECT COUNT(*)
        FROM QUANLY_DUAN QL
        WHERE QL.MA_DUAN = DA.MA_DUAN) AS SoNhanVien
    FROM DU_AN DA
    WHERE DA.NGAY_KET_THUC < GETDATE();
GO

CREATE VIEW V_NhanVien_Update
AS
    SELECT ID_NHANVIEN, TEN_NV, LUONG
    FROM NHAN_VIEN;
GO

UPDATE V_NhanVien_Update
SET LUONG = 20000000
WHERE ID_NHANVIEN = 'NV001';

CREATE CLUSTERED INDEX IDX_NV_CLUSTERED
ON NHAN_VIEN(ID_NHANVIEN);

SELECT *
FROM sys.indexes
WHERE object_id = OBJECT_ID('NHAN_VIEN');

CREATE NONCLUSTERED INDEX IDX_NV_MA_PB
ON NHAN_VIEN(PHG);

SET STATISTICS IO ON;
SELECT *
FROM NHAN_VIEN NV
    JOIN PHONG_BAN PB ON NV.PHG = PB.MA_PB;
SET STATISTICS IO OFF;

CREATE NONCLUSTERED INDEX IDX_QLDA_MANV_MADA
ON QUANLY_DUAN(MA_NHANVIEN, MA_DUAN);

SELECT *
FROM QUANLY_DUAN
WHERE MA_NHANVIEN = 'NV001' AND MA_DUAN = 'DA001';

CREATE NONCLUSTERED INDEX IDX_NV_LUONG_CAO
ON NHAN_VIEN(LUONG)
WHERE LUONG > 10000000;

SELECT *
FROM NHAN_VIEN
WHERE LUONG > 10000000;

CREATE NONCLUSTERED INDEX IDX_NV_COVER
ON NHAN_VIEN(PHG)
INCLUDE (TEN_NV, LUONG);

SELECT TEN_NV, LUONG
FROM NHAN_VIEN
WHERE PHG = 'PB001';

CREATE NONCLUSTERED INDEX IDX_DUAN_MADA
ON DU_AN(MA_DUAN);

CREATE NONCLUSTERED INDEX IDX_QLDA_MANV
ON QUANLY_DUAN(MA_NHANVIEN);
GO

CREATE VIEW V_QuanLyDA
AS
    SELECT DA.TEN_DUAN, NV.TEN_NV
    FROM DU_AN DA
        JOIN QUANLY_DUAN QL ON DA.MA_DUAN = QL.MA_DUAN
        JOIN NHAN_VIEN NV ON QL.MA_NHANVIEN = NV.ID_NHANVIEN;
GO

DROP INDEX IDX_NV_MA_PB ON NHAN_VIEN;

CREATE UNIQUE INDEX UQ_QLDA_MANV_MADA
ON QUANLY_DUAN(MA_NHANVIEN, MA_DUAN);

INSERT INTO QUANLY_DUAN
VALUES
    ('DA001', 'NV001', '2024-01-01', '2024-06-30', 100, N'Test');
GO

CREATE VIEW V_BaoCaoLuongPhong
AS
    SELECT PHG, AVG(LUONG) AS LuongTB
    FROM NHAN_VIEN
    GROUP BY PHG;
GO

CREATE NONCLUSTERED INDEX IDX_NV_PHG
ON NHAN_VIEN(PHG);
