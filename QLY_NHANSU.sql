CREATE DATABASE QLY_NHANSU;
USE QLY_NHANSU;

CREATE TABLE PHONG_BAN
(
    MA_PB CHAR(5) NOT NULL,
    TEN_PB NVARCHAR(50) NOT NULL,
    MA_TRUONGPHONG CHAR(5)
);

CREATE TABLE NHAN_VIEN
(
    ID_NHANVIEN CHAR(5) NOT NULL,
    HO_NV NVARCHAR(30),
    TEN_NV NVARCHAR(30) NOT NULL,
    NAM_SINH SMALLINT,
    DIA_CHI NVARCHAR(100),
    GIOI_TINH CHAR(1) NOT NULL,
    LUONG DECIMAL(12,2),
    PHG CHAR(5) NOT NULL,
    EMAIL VARCHAR(100) NOT NULL,
    DIENTHOAI VARCHAR(15) NOT NULL
);

CREATE TABLE DU_AN
(
    MA_DUAN CHAR(5) NOT NULL,
    TEN_DUAN NVARCHAR(50) NOT NULL,
    NGAY_BAT_DAU DATE NOT NULL,
    NGAY_KET_THUC DATE NOT NULL,
);

CREATE TABLE QUANLY_DUAN
(
    MA_DUAN CHAR(5) NOT NULL,
    MA_NHANVIEN CHAR(5) NOT NULL,
    NGAY_THAM_GIA DATE NOT NULL,
    NGAY_KET_THUC DATE NOT NULL,
    SO_GIO INT,
    VAI_TRO NVARCHAR(50) NOT NULL
);

ALTER TABLE PHONG_BAN
ADD CONSTRAINT PK_PHONG_BAN PRIMARY KEY (MA_PB)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY (ID_NHANVIEN)

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT PK_QUANLY_DUAN PRIMARY KEY (MA_DUAN,MA_NHANVIEN)

ALTER TABLE DU_AN
ADD CONSTRAINT PK_DUAN PRIMARY KEY (MA_DUAN)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT FK_NHAN_VIEN_PHONGBAN
FOREIGN KEY(PHG)
REFERENCES PHONG_BAN(MA_PB)

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT FK_QUANLY_DUAN_NHAN_VIEN
FOREIGN KEY(MA_NHANVIEN)
REFERENCES NHAN_VIEN(ID_NHANVIEN)

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT FK_QUANLY_DUAN_DU_AN
FOREIGN KEY(MA_DUAN)
REFERENCES DU_AN(MA_DUAN)

ALTER TABLE NHAN_VIEN
ADD EMAIL VARCHAR(100) NOT NULL,
    DIENTHOAI VARCHAR(15) NOT NULL

ALTER TABLE QUANLY_DUAN
DROP COLUMN VAI_TRO

ALTER TABLE QUANLY_DUAN
ADD CHUC_VU NVARCHAR(30) NOT NULL

ALTER TABLE QUANLY_DUAN
ADD CONSTRAINT CHK_QUANLY_DUAN CHECK (SO_GIO >= 0);

ALTER TABLE DU_AN
ADD THONG_TIN_KHACH_HANG NVARCHAR(MAX)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT CHK_NHAN_VIEN CHECK (GIOI_TINH IN ('M', 'F') );

INSERT INTO PHONG_BAN
    (MA_PB, TEN_PB, MA_TRUONGPHONG)
VALUES
    ('PB001', 'CNTT', 'NV001'),
    ('PB002', 'Ke toan', 'NV002'),
    ('PB003', 'Nhan su', 'NV003');

INSERT INTO NHAN_VIEN
    (ID_NHANVIEN, HO_NV, TEN_NV, NAM_SINH, DIA_CHI, GIOI_TINH, LUONG, PHG, EMAIL, DIENTHOAI)
VALUES
    ('NV001', 'Nguyen', 'An', 1995, 'Ha Noi', 'M', 15000000, 'PB001', 'an.nguyen@gmail.com', '0901234567'),
    ('NV002', 'Tran', 'Binh', 1990, 'Ho Chi Minh', 'M', 18000000, 'PB002', 'binh.tran@gmail.com', '0912345678'),
    ('NV003', 'Le', 'Hoa', 1998, 'Da Nang', 'F', 14000000, 'PB003', 'hoa.le@gmail.com', '0923456789'),
    ('NV004', 'Pham', 'Minh', 1997, N'Ha Noi', 'M', 16000000, 'PB001', 'minh.pham@gmail.com', '0934567890');

INSERT INTO DU_AN
    (MA_DUAN, TEN_DUAN, NGAY_BAT_DAU, NGAY_KET_THUC)
VALUES
    ('DA001', 'He thong quan ly nhan su', '2024-01-01', '2024-06-30'),
    ('DA002', 'Website ban hang', '2024-02-01', '2024-08-31'),
    ('DA003', 'Ung dung di dong', '2024-03-01', '2024-12-31');

INSERT INTO QUANLY_DUAN
    (MA_DUAN, MA_NHANVIEN, NGAY_THAM_GIA, NGAY_KET_THUC, SO_GIO, CHUC_VU)
VALUES
    ('DA001', 'NV001', '2024-01-01', '2024-06-30', 300, 'Lap trinh vien'),
    ('DA001', 'NV003', '2024-02-01', '2024-06-30', 200, 'Kiem thu'),
    ('DA002', 'NV002', '2024-02-01', '2024-08-31', 350, 'Quan ly du an'),
    ('DA003', 'NV004', '2024-03-01', '2024-12-31', 400, 'Lap trinh vien');

SELECT *
FROM NHAN_VIEN

SELECT HO_NV AS 'Ho Nhan Vien', TEN_NV AS 'Ten Nhan Vien', NAM_SINH
FROM NHAN_VIEN

SELECT HO_NV + ' ' + TEN_NV AS 'Ho va Ten Nhan Vien', NAM_SINH
FROM NHAN_VIEN

SELECT DISTINCT HO_NV
FROM NHAN_VIEN

SELECT TOP 3
    *
FROM NHAN_VIEN
ORDER BY LUONG DESC

SELECT *
FROM NHAN_VIEN
WHERE TEN_NV LIKE '%Minh%'

SELECT HO_NV, TEN_NV
FROM NHAN_VIEN
WHERE LUONG >= 800

SELECT HO_NV, TEN_NV
FROM NHAN_VIEN
WHERE LUONG BETWEEN 800 AND 1000

SELECT *
FROM DU_AN
WHERE NGAY_BAT_DAU >= '2017-01-01'

SELECT *
FROM PHONG_BAN
WHERE TEN_PB LIKE '%San Xuat%'

SELECT *
FROM NHAN_VIEN
ORDER BY LUONG DESC

SELECT AVG(LUONG)
FROM NHAN_VIEN
WHERE PHG = 'PB001'

SELECT COUNT(NGAY_KET_THUC)
FROM DU_AN
WHERE NGAY_KET_THUC < '2016-12-31'